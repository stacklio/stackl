---
- hosts: nodes
  become: true
  vars_files:
    - "vars/{{ env }}.yml"
  tasks: []

- hosts: swarm_manager_main
  become: true
  gather_facts: no
  vars_files:
    - "vars/{{ env }}.yml"
  tasks:
    - file:
        state: directory
        path: "{{item}}"
      loop:
        - "/root/docker-compose/"
    - name: Create docker_pull
      template:
        src: "{{ pull_source }}"
        dest: "{{ pull_path }}"
        owner: root
        group: root
        mode: 0644
    - name: Create docker compose
      template:
        src: templates/{{docker_compose_name}}.j2
        dest: "{{ docker_compose_path }}"
        owner: root
        group: root
        mode: 0744
        backup: yes
    - name: Pull containers
      command: "sh {{ pull_path }}"
    - name: Remove running compose
      command: "docker stack rm stackl"
    - name: Running docker-compose
      command: "docker stack deploy -c {{ docker_compose_path }} --with-registry-auth stackl"

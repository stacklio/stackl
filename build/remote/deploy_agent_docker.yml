---
- hosts: swarm_manager_main
  become: true
  gather_facts: no
  vars_files:
    - "vars/{{ env }}.yml"
  tasks:
    - name: get public_ip4 output
      shell: curl http://169.254.169.254/latest/meta-data/public-ipv4
      register: public_ipv4
    - debug:
        var: public_ipv4.stdout
    - name: Create docker_pull
      template:
        src: templates/docker_pull_agent.j2
        dest: /root/pull_agent.sh
        owner: root
        group: root
        mode: 0644
    - name: Pull containers
      command: "sh /root/pull_agent.sh"
    - name: (re)-create the stackl agent
      docker_container:
        name: stackl_agent
        image: registry.gitlab.com/stackl-core/v2/stackl2/stackl_agent
        state: started
        exposed_ports: 8889
        published_ports: 8889:8889
        recreate: yes
        env:
          STACKL_HOST: "{{ stackl_host }}"
          HOST_MACHINE: "{{ public_ipv4.stdout }}"
          TAGS: "['common', 'tom', 'sven', 'frederic']"